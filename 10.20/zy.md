10月20日 韩天昊
# 工单03说明文档


### 一、核心用户与需求

**核心用户**
电商商家：特别是负责店铺整体运营的运营负责人或选品经理。

**核心需求**
1.商家需要一个工具，能够从销售、属性、流量、人群等多个角度，对店铺自身经营的各个品类进行深入了解。

2.提供商品效果、流量来源、价格、关键词、内容、消费者行为、服务体验等各个维度的数据，以便进行精细化运营、提升商品竞争力。



## 二、数据分层架构与实现

本项目严格遵循了离线数仓的五层架构（ODS -> DIM -> DWD -> DWS -> ADS）思想，实现了数据从原始到应用的逐层加工、清洗、聚合和应用。这种分层设计是现代数据仓库的核心，它带来了诸多优势。

### 为什么需要分层？

- **降低复杂度**：将复杂的数据处理流程分解为多个简单的步骤。

- **模块化管理**：各层职责分明，便于团队协作和维护。

- **提高复用性**：上层可以复用下层的成果，避免重复开发。

- **隔离数据问题**：某一层的数据或逻辑问题不会直接影响到上层应用。

- **提升数据质量**：通过层层清洗和校验，保证最终数据的准确性。

- **优化性能**：下层进行预聚合，减少上层查询的计算量，提高查询性能。


### 1. ODS层

#### 作用

- 作为数仓的最底层，它是业务系统数据的镜像。主要进行全量或增量抽取，保持数据的原始状态，仅做最基础的存储和分区，防止全表扫描。


#### 技术实现

- **存储格式**：TEXTFILE，便于接收各种来源的原始数据。

- **压缩格式**：LZO，通过`INPUTFORMAT 'com.hadoop.mapred.DeprecatedLzoTextInputFormat'`指定，兼顾了压缩比和分片能力，减少数据占用的存储空间，提升查询效率。

- **分区策略**：按天（`dt`）进行分区，是大数据处理的标准实践。

#### 关键表

- `ods_sku_info`：SKU商品表。

- `ods_order_info`：订单表。

- `ods_payment_info`：支付流水表。

- `ods_comment_info`：商品评论表。

- `ods_base_category3`：商品三级分类表。

- `ods_user_info`：用户表。

- `ods_shop_info`：店铺信息表。


### 2. DIM层

#### 作用

- 存储稳定、变化频率低的维度信息。维度表是用来解释和说明业务事实的“字典表”，它通常与事实表一起构成星型模型。在HQL中，维度就是“用来分组、过滤、看汇总”的那些描述性字段。


#### 技术实现

- **存储格式**：PARQUET，列式存储，非常适合分析型查询。

- **压缩格式**：LZO。


#### 关键表

- `dim_sku_info`：商品维度表。这是本项目的核心维度表，通过将`ods_sku_info`与类目、库存等信息关联，丰富了商品的属性，为后续所有分析提供了强大的支撑。
- `dim_user_info` 用户维度表， 计算用户年龄，划分性别，区分新老用户。
- `dim_activity_info` 活动维度表，用于存储电商平台中各种营销活动的详细信息。为数据分析和业务决策提供了基础数据支持


### 3. DWD层

#### 作用

- 对ODS层的数据进行清洗、去重、标准化、维度退化，构建出干净、统一、原子粒度的事实表。这是数据仓库的“黄金层”，为上层分析提供一致、可信的数据基础。


#### 技术实现

- **存储格式**：PARQUET。

- **压缩格式**：LZO。


#### 关键表

- **事实表**

    - `dwd_order_detail`：清洗后的订单明细事实表，处理了订单详情、支付状态、金额等逻辑。

    - `dwd_cart_detail`：加购明细事实表，清洗加购数据，支撑加购相关分析

    - `dwd_favor_detail`：收藏明细表，清洗收藏数据，支撑商品收藏人数指标

    - `dwd_comment_detail`：评价事实表，清洗评价数据，统一评价类型编码，支撑评价分析指标

    - `dwd_log_detail`：用户行为日志事实表，解析ods_z_log的 JSON 日志，提取用户行为（浏览、点击、收藏）、流量渠道等信息，支撑 PV/UV/ 跳出率 / 渠道分析。

- **维度表**

    - `dim_sku_info`：商品维度表（在DWD层创建，扮演DIM层角色）。


### 4. DWS层

#### 作用

- 预聚合，将DWD层的业务事实按“维度+度量”进行轻度汇总，减少指标的重复计算，提高代码复用性，保留下钻能力，减少数据量，从而显著提高查询性能。


#### 技术实现

- **存储格式**：PARQUET。

- **压缩格式**：LZO。


#### 关键表

- ``dws_user_action_day_sum``：用户每日流量表。用于存储和分析电商平台中用户行为的日常汇总数据。为数据分析和业务决策提供关于用户行为和流量分布的综合视图。

- ``dws_order_day_sum``：订单分析表。用于存储每日订单相关的汇总数据，为电商平台的业务分析和决策提供关于订单的综合信息。

- ``dws_sku_sales_day_sum``：店铺日销售表。按日汇总每个SKU（Stock Keeping Unit，库存进出计量的基本单元）的销售情况

- `dws_comment_day_sum`   店铺商品评价表，为数据分析和业务决策提供关于商品评价的聚合信息

- ``dws_favor_day_sum``： 品牌商品收藏表，通过汇总每日的收藏行为，为数据分析和业务决策提供支持。


### 5. ADS层

#### 作用

- 面向“品类360看板”这一具体的应用场景，将DWS层的多个汇总表进行JOIN，计算出最终的、可直接用于前端BI工具（如生意参谋）展示的宽表。这是数据价值的最终出口。


#### 技术实现

- **存储格式**：PARQUET。

- **压缩格式**：LZO。


#### 实现方式

- **分层实现（Recommended）**

    - **优点**：逻辑清晰，各层职责分明，数据可复用，易于维护和排查问题。

    - **过程**：ODS -> DWD -> DWS -> ADS。ADS层的SQL通过JOIN `dws_user_action_day_sum`、`dws_order_day_sum`、`dws_sku_sales_day_sum`等DWS表来构建最终结果。

- **不分层实现**

    - **优点**：开发速度快，代码集中。

    - **缺点**：逻辑复杂，难以维护，性能可能不佳，数据不可复用。

    - **过程**：直接从DWD层的`dwd_order_detail`、`dwd_page_log`等事实表，以及`dim_sku_info`维度表，进行复杂的JOIN和GROUP BY，在一个SQL中完成所有计算。




#### 三、 关键指标与功能实现

##### 1.销售分析：

- **核心指标**：
    - 支付买家数 (pay_buyer_num)：商品的支付买家数，反映商品的购买用户规模。
    -
    - 加购人数 (cart_buyer_num)：商品的加购人数，反映有加购意愿的用户规模。
    -
    - 支付件数 (pay_num)：商品的支付件数，反映商品的销量规模。
    -
    - 支付转化率 (pay_conversion_rate)：支付买家数与商品访客数的比率，反映商品的转化能力。

来源 ： （ads_sku_conversion_sales_day)


##### 2.流量分析：

- **核心指标**：
    - **总UV (`total_uv`)**：当日去重的访客数，反映独立访客的数量。

    - **跳出率 (`jump_rate`)**：仅浏览一次页面的会话占比，反映页面的吸引力和用户体验。

    - **渠道PV分布 (`app_pv`, `pc_pv`, `wx_pv`, `h5_pv`)**：不同渠道（APP、PC、微信、H5）的页面浏览次数，反映各渠道的流量贡献。

    - **渠道UV分布 (`app_uv`, `pc_uv`, `wx_uv`, `h5_uv`)**：不同渠道的独立访客数，反映各渠道的用户覆盖情况。

来源：  (`ads_sku_traffic_day`)


##### 3， 价格分析：

**核心指标：**
当日支付用户数 (pay_num)：当日完成支付的用户数量，反映实际成交情况。
当日退款数 (refund_num)：当日发生退款的订单数量，反映订单的稳定性。
当日销售额 (total_sales)：当日完成支付的总金额，反映销售额。
当日销量 (sale_num)：当日销售的数量，反映价格情况。
支付转化率 pay_conversion_rate (avg_order_amt)：支付转化率（支付买家数/商品访客数)


来源： ads_sku_conversion_sales_day  dws_sku_sales_day_sum


#### 4:客群洞察:

指标：访问该品类的搜索/访问/支付人群的male_ratio,fmale_ratio（性别分布）、total_visitor_num（总访客数）、new_old_ratio（新老客户占比）。

来源：dws_store_gender_daycount, ads_sku_customer_insight_day












